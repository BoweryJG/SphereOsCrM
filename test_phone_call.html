<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twilio Browser Call Test</title>
    <script src="https://sdk.twilio.com/js/client/releases/1.14.0/twilio.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .call-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        input, button {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        button {
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            border: none;
            font-weight: bold;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .control-panel {
            display: flex;
            gap: 10px;
        }
        #endCall {
            background-color: #f44336;
        }
        #endCall:hover {
            background-color: #d32f2f;
        }
        .status-indicators {
            margin: 20px 0;
            padding: 15px;
            background-color: #f0f8ff;
            border-radius: 8px;
            border: 1px solid #b8daff;
        }
        .indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .indicator-label {
            font-weight: bold;
        }
        .indicator-value {
            padding: 3px 8px;
            border-radius: 4px;
            background-color: #e9e9e9;
        }
        .logs {
            margin-top: 30px;
            height: 200px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .error {
            color: #f44336;
        }
        .success {
            color: #4CAF50;
        }
        .info {
            color: #2196F3;
        }
        #callDuration {
            font-family: monospace;
            font-size: 24px;
            text-align: center;
            margin: 10px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Twilio Browser Call Test</h1>
        <p>A simple tool to test browser-based calling functionality</p>
    </div>

    <div class="status-indicators">
        <div class="indicator">
            <span class="indicator-label">Status:</span>
            <span class="indicator-value" id="status">Not connected</span>
        </div>
        <div class="indicator">
            <span class="indicator-label">Device:</span>
            <span class="indicator-value" id="deviceStatus">Not initialized</span>
        </div>
    </div>

    <div id="callDuration">00:00</div>

    <div class="call-controls">
        <div class="input-group">
            <label for="phoneNumber">Step 1: Enter a phone number to call</label>
            <input type="tel" id="phoneNumber" placeholder="+1234567890" />
        </div>

        <button id="tokenButton">Step 2: Get Token</button>

        <div class="control-panel">
            <button id="startCall" disabled>Step 3: Make Call</button>
            <button id="endCall" disabled>End Call</button>
        </div>

        <div class="control-panel">
            <button id="toggleMute" disabled>Mute</button>
            <button id="toggleSpeaker" disabled>Speaker Off</button>
        </div>
    </div>

    <div class="logs">
        <h3>Event Log</h3>
        <div id="logContainer"></div>
    </div>

    <script>
        let device;
        let token;
        let currentCall;
        let durationTimer;
        let isMuted = false;
        let isSpeakerOn = true;
        let callDuration = 0;

        const tokenButton = document.getElementById('tokenButton');
        const startCallButton = document.getElementById('startCall');
        const endCallButton = document.getElementById('endCall');
        const toggleMuteButton = document.getElementById('toggleMute');
        const toggleSpeakerButton = document.getElementById('toggleSpeaker');
        const phoneNumberInput = document.getElementById('phoneNumber');
        const statusDisplay = document.getElementById('status');
        const deviceStatusDisplay = document.getElementById('deviceStatus');
        const callDurationDisplay = document.getElementById('callDuration');
        const logContainer = document.getElementById('logContainer');

        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.prepend(entry);
        }

        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function startDurationTimer() {
            callDuration = 0;
            callDurationDisplay.style.display = 'block';
            callDurationDisplay.textContent = formatDuration(0);
            
            durationTimer = setInterval(() => {
                callDuration++;
                callDurationDisplay.textContent = formatDuration(callDuration);
            }, 1000);
        }

        function stopDurationTimer() {
            if (durationTimer) {
                clearInterval(durationTimer);
                durationTimer = null;
            }
            setTimeout(() => {
                callDurationDisplay.style.display = 'none';
            }, 2000);
        }

        tokenButton.addEventListener('click', async () => {
            try {
                log('Requesting token from server...');
                statusDisplay.textContent = 'Connecting...';

                // Replace with your actual token endpoint
                const response = await fetch('/.netlify/functions/initiate-twilio-call/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ identity: 'test-user-' + Date.now() }),
                });

                if (!response.ok) {
                    throw new Error('Failed to get token');
                }

                const data = await response.json();
                token = data.token;
                
                log('Token received', 'success');
                initializeDevice();
            } catch (error) {
                log(`Error getting token: ${error.message}`, 'error');
                statusDisplay.textContent = 'Error';
            }
        });

        function initializeDevice() {
            if (!token) {
                log('No token available', 'error');
                return;
            }

            try {
                device = Twilio.Device.setup(token, {
                    debug: true,
                    warnings: true
                });

                device.on('ready', function() {
                    deviceStatusDisplay.textContent = 'Ready';
                    startCallButton.disabled = false;
                    log('Device initialized and ready', 'success');
                });

                device.on('error', function(error) {
                    log('Device error: ' + error.message, 'error');
                    deviceStatusDisplay.textContent = 'Error';
                });

                device.on('offline', function() {
                    deviceStatusDisplay.textContent = 'Offline';
                    log('Device went offline', 'info');
                });

                device.on('incoming', function(connection) {
                    log('Incoming call from ' + connection.parameters.From, 'info');
                    
                    // Auto-answer for testing
                    if (confirm('Incoming call. Answer?')) {
                        connection.accept();
                        currentCall = connection;
                        setupCallHandlers();
                        statusDisplay.textContent = 'Connected';
                        startDurationTimer();
                    } else {
                        connection.reject();
                    }
                });
                
                log('Initializing device...', 'info');
            } catch (error) {
                log(`Error initializing device: ${error.message}`, 'error');
            }
        }

        startCallButton.addEventListener('click', () => {
            if (!device) {
                log('Device not initialized', 'error');
                return;
            }

            const number = phoneNumberInput.value.trim();
            if (!number) {
                log('Please enter a phone number', 'error');
                return;
            }

            statusDisplay.textContent = 'Calling...';
            log(`Calling ${number}...`);

            try {
                const params = {
                    To: number
                };

                currentCall = device.connect(params);
                setupCallHandlers();

                endCallButton.disabled = false;
                toggleMuteButton.disabled = false;
                toggleSpeakerButton.disabled = false;
                startCallButton.disabled = true;
            } catch (error) {
                log(`Error making call: ${error.message}`, 'error');
                statusDisplay.textContent = 'Error';
            }
        });

        function setupCallHandlers() {
            currentCall.on('accept', function() {
                log('Call accepted', 'success');
                statusDisplay.textContent = 'Connected';
                startDurationTimer();
            });

            currentCall.on('disconnect', function() {
                log('Call ended', 'info');
                statusDisplay.textContent = 'Disconnected';
                
                endCallButton.disabled = true;
                toggleMuteButton.disabled = true;
                toggleSpeakerButton.disabled = true;
                startCallButton.disabled = false;
                
                stopDurationTimer();
                currentCall = null;
                
                // Reset after a brief delay
                setTimeout(() => {
                    statusDisplay.textContent = 'Ready';
                }, 3000);
            });

            currentCall.on('error', function(error) {
                log('Call error: ' + error.message, 'error');
                statusDisplay.textContent = 'Error';
            });
        }

        endCallButton.addEventListener('click', () => {
            if (currentCall) {
                log('Ending call...');
                currentCall.disconnect();
            }
        });

        toggleMuteButton.addEventListener('click', () => {
            if (!currentCall) return;
            
            isMuted = !isMuted;
            currentCall.mute(isMuted);
            toggleMuteButton.textContent = isMuted ? 'Unmute' : 'Mute';
            log(isMuted ? 'Call muted' : 'Call unmuted');
        });

        toggleSpeakerButton.addEventListener('click', () => {
            isSpeakerOn = !isSpeakerOn;
            toggleSpeakerButton.textContent = isSpeakerOn ? 'Speaker Off' : 'Speaker On';
            log(isSpeakerOn ? 'Speaker on' : 'Speaker off');
            
            // In a real implementation, you would control the audio output here
            // This is just for the UI simulation
        });

        log('Application loaded. Click "Get Token" to start.', 'info');
    </script>
</body>
</html>
